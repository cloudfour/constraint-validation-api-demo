---
import CustomerEmail from './form-fields/CustomerEmail.astro';
import PurchaseDate from './form-fields/PurchaseDate.astro';
import CustomerNameFirst from './form-fields/CustomerNameFirst.astro';
import CustomerNameLast from './form-fields/CustomerNameLast.astro';
import ToggleCheckbox from './form-fields/ToggleCheckbox.astro';
---

<form id="demo-form-2" action="" method="post">
  <fieldset>
    <legend>Customer details</legend>
    <div class="field-wrapper">
      <CustomerNameFirst />
      <p class="error"></p>
    </div>
    <div class="field-wrapper">
      <CustomerNameLast />
      <p class="error"></p>
    </div>
    <div class="field-wrapper">
      <CustomerEmail />
      <p class="error"></p>
    </div>
  </fieldset>

  <fieldset>
    <legend>Purchase details</legend>
    <div class="field-wrapper">
      <PurchaseDate />
      <p class="error"></p>
    </div>
  </fieldset>

  <fieldset>
    <legend>Interests</legend>
    <div class="field-wrapper checkbox-field-wrapper">
      <ToggleCheckbox
        id="coding"
        name="interests"
        value="coding"
        label="Coding"
      />
      <ToggleCheckbox id="music" name="interests" value="music" label="Music" />
      <ToggleCheckbox id="art" name="interests" value="art" label="Art" />
      <ToggleCheckbox
        id="sports"
        name="interests"
        value="sports"
        label="Sports"
      />
      <p hidden class="error js-interests-validation-error"></p>
    </div>
  </fieldset>

  <button type="submit">Submit</button>
</form>

<style lang="scss">
  html,
  body {
    margin: 0;
    padding: 0;

    @media ((prefers-color-scheme: dark)) {
      background-color: #000;
    }
  }
  button {
    margin-block-start: 1.5em;
  }

  .checkbox-field-wrapper {
    background-image: var(--bg-validation-state);
    background-repeat: no-repeat;
    background-position: right 0.3em center;
    background-size: 1.8em;
    padding-inline-end: 2.2em;

    &.is-valid {
      --bg-validation-state: var(--bg-valid);
    }

    &.is-invalid {
      --bg-validation-state: var(--bg-invalid);
    }
  }
</style>

<script>
  /**
   * Update the validation UI state for a given input element.
   * @param {HTMLInputElement} inputEl The input element to update the UI state for.
   */
  const updateValidationUiStateForInput = (inputEl: HTMLInputElement) => {
    // Get the error message element for the current input element.
    const errorEl = inputEl.nextElementSibling as HTMLElement;
    // Check if the input is valid using the Constraint Validation API.
    if (inputEl.checkValidity()) {
      inputEl.classList.add('is-valid');
      inputEl.classList.remove('is-invalid');
      errorEl.textContent = '';
    } else {
      inputEl.classList.remove('is-valid');
      inputEl.classList.add('is-invalid');
      // Use the validation message from the Constraint Validation API.
      errorEl.textContent = inputEl.validationMessage;
    }
  };

  /**
   * Validate input fields using the Constraint Validation API.
   * @returns {boolean} Was an invalid field found?
   */
  const useConstraintValidationApi = (): boolean => {
    // Keep track of the validation state.
    let areAllConstraintValidationFieldsValid = true;
    // Keep track of the first invalid input element.
    let firstInvalidInputEl: HTMLInputElement | null = null;
    // Loop all inputs that can be validated with the Constraint Validation API.
    document
      .querySelectorAll('.js-validate')
      .forEach((inputEl: HTMLInputElement) => {
        // If the first invalid input element has not been set, set it to the
        // current input element. Also, update the validation state.
        if (!inputEl.checkValidity() && !firstInvalidInputEl) {
          firstInvalidInputEl = inputEl;
          areAllConstraintValidationFieldsValid = false;
        }
        // Update the UI
        updateValidationUiStateForInput(inputEl);
      });
    // If there is an invalid input element, focus on it.
    firstInvalidInputEl?.focus();
    // Return if all input elements are valid.
    return areAllConstraintValidationFieldsValid;
  };

  /**
   * Validates the "interests" checkbox group.
   * Custom validation is required because checkbox group validation is not
   * supported by the Constraint Validation API.
   * @return {boolean} Is the "interests" checkbox group valid?
   */
  const validateInterestsCheckboxGroup = (form: HTMLFormElement): boolean => {
    console.log('validateInterestsCheckboxGroup');
    // Get the element where the validation error message will be displayed.
    const errorEl = document.querySelector(
      '.js-interests-validation-error'
    ) as HTMLElement;
    // Are any of the "interests" checkboxes checked?
    const isInterestsValid = new FormData(form).getAll('interests').length > 0;
    // Get all the "interests" checkboxes.
    const interestsCheckboxInputEls = document.querySelectorAll(
      'input[name="interests"]'
    );
    // Get the wrapper element for the "interests" checkbox group.
    const checkboxGroupWrapperEl = document.querySelector(
      '.checkbox-field-wrapper'
    );

    // Update the UI.
    if (isInterestsValid) {
      // Need to place the `is-valid` class higher up in the DOM tree to
      // show a validation state icon (one icon for the group of checkboxes).
      checkboxGroupWrapperEl.classList.add('is-valid');
      checkboxGroupWrapperEl.classList.remove('is-invalid');
      // Update the validation UI state for each checkbox.
      interestsCheckboxInputEls.forEach((checkboxInputEl: HTMLInputElement) => {
        checkboxInputEl.classList.add('is-valid');
        checkboxInputEl.classList.remove('is-invalid');
      });
      // When the checkbox group is valid, hide the error message.
      errorEl.textContent = '';
      errorEl.hidden = true;
    } else {
      checkboxGroupWrapperEl.classList.remove('is-valid');
      checkboxGroupWrapperEl.classList.add('is-invalid');
      // Update the validation UI state for each checkbox.
      interestsCheckboxInputEls.forEach((checkboxInputEl: HTMLInputElement) => {
        checkboxInputEl.classList.remove('is-valid');
        checkboxInputEl.classList.add('is-invalid');
      });
      // When the checkbox group is invalid, show the error message.
      errorEl.textContent = 'Please choose at least one interest.';
      errorEl.hidden = false;
    }

    // Return the validation state.
    return isInterestsValid;
  };

  /**
   * Handler for form `submit` event.
   * @param {SubmitEvent} event
   */
  const onSubmit = (event: SubmitEvent) => {
    const areAllConstraintValidationFieldsValid = useConstraintValidationApi();
    const isInterestsValid = validateInterestsCheckboxGroup(
      event.target as HTMLFormElement
    );
    // If any of the validation checks fail, prevent the form from submitting.
    if (!areAllConstraintValidationFieldsValid || !isInterestsValid) {
      event.preventDefault();
    }
  };

  /**
   * Initialize validation setup
   */
  const init = () => {
    // Update the JS enabled state
    document.body.dataset.jsEnabled = 'true';

    /** @type {HTMLFormElement} */
    const form: HTMLFormElement = document.querySelector('#demo-form-2');
    // Disable built-in validation. The Constraint Validation API to be used instead.
    form.setAttribute('novalidate', 'true');
    // Listen for a form `submit` event.
    form.addEventListener('submit', onSubmit);

    // Set up `blur` and `input` validation for the inputs that can be validated
    // with the Constraint Validation API.
    document.querySelectorAll('.js-validate').forEach((inputEl) => {
      inputEl.addEventListener('input', (event) =>
        updateValidationUiStateForInput(event.target as HTMLInputElement)
      );
      inputEl.addEventListener('blur', (event) =>
        updateValidationUiStateForInput(event.target as HTMLInputElement)
      );
    });

    // Set up `blur` validation for the "interests" checkbox group.
    document
      .querySelectorAll('input[name="interests"]')
      .forEach((checkboxInputEl) => {
        checkboxInputEl.addEventListener('blur', () => {
          // Use a setTimeout to wait for the focus to move to the next element
          // before validating the checkbox group.
          setTimeout(() => {
            // Only validate when the focus is no longer on the "interests"
            // checkbox group.
            if (document.activeElement.getAttribute('name') !== 'interests') {
              validateInterestsCheckboxGroup(form);
            }
          }, 0);
        });
      });

    // The `user-invalid` CSS pseudo-class is not supported in all browsers.
    try {
      // The `user-invalid` CSS pseudo-class will stick around on a page refresh.
      // This ensures that the invalid inputs also get the error message displayed.
      document
        .querySelectorAll('input:user-invalid')
        .forEach((inputEl: HTMLInputElement) =>
          updateValidationUiStateForInput(inputEl)
        );
    } catch (error) {
      console.warn('The `:user-invalid` CSS pseudo-class is not supported.');
    }
  };

  init();
</script>
